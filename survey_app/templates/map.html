<!DOCTYPE html>
<html>
<head>
  <title>Survey Map</title>

  <link rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    #map { height: 95vh; }
    img { width: 90px; margin: 4px; }
    .popup-box { font-size: 12px; }
  </style>
</head>
<body>

<div id="map"></div>

<script>
const map = L.map("map").setView([30.3163, 78.0329], 6);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
  .addTo(map);

// -----------------------------
// 1️⃣ Load survey locations
// -----------------------------
fetch("/api/map-data/")
  .then(res => res.json())
  .then(data => {
    data.forEach(site => {
      const marker = L.marker([site.lat, site.lon]).addTo(map);

      marker.on("click", () => {
        showSurveyPopup(site);
      });
    });
  });

function showSurveyPopup(site) {
  const html = `
    <div class="popup-box">
      <b>${site.address}</b><br>
      ${site.city}, ${site.state}<br>
      <b>Lat:</b> ${site.lat}<br>
      <b>Lon:</b> ${site.lon}<br><hr>
      <img src="${site.photos.north}">
      <img src="${site.photos.east}">
      <img src="${site.photos.south}">
      <img src="${site.photos.west}">
    </div>
  `;

  L.popup()
    .setLatLng([site.lat, site.lon])
    .setContent(html)
    .openOn(map);
}

// -----------------------------
// 2️⃣ 3-POINT CLICK LOGIC
// -----------------------------
let points = [];
let markers = [];
let line = null;

map.on("click", function(e) {
  if (points.length === 3) reset();

  const p = { lat: e.latlng.lat, lon: e.latlng.lng };
  points.push(p);

  markers.push(L.marker(e.latlng).addTo(map));

  if (points.length === 3) {
    drawTriangle();
    showMeasurements();
  }
});

function drawTriangle() {
  const latlngs = points.map(p => [p.lat, p.lon]);
  latlngs.push(latlngs[0]);
  line = L.polyline(latlngs, { color: "red" }).addTo(map);
}

function showMeasurements() {
  const d1 = distance(points[0], points[1]);
  const d2 = distance(points[1], points[2]);
  const d3 = distance(points[2], points[0]);

  const a1 = bearing(points[0], points[1]);
  const a2 = bearing(points[1], points[2]);
  const a3 = bearing(points[2], points[0]);

  const center = centroid(points);

  L.popup()
    .setLatLng(center)
    .setContent(`
      <b>Distances (km)</b><br>
      P1-P2: ${d1.toFixed(2)}<br>
      P2-P3: ${d2.toFixed(2)}<br>
      P3-P1: ${d3.toFixed(2)}<hr>
      <b>Angles (°)</b><br>
      A1: ${a1.toFixed(1)}<br>
      A2: ${a2.toFixed(1)}<br>
      A3: ${a3.toFixed(1)}
    `)
    .openOn(map);
}

// -----------------------------
// Math helpers
// -----------------------------
function distance(p1, p2) {
  const R = 6371;
  const dLat = rad(p2.lat - p1.lat);
  const dLon = rad(p2.lon - p1.lon);
  const a = Math.sin(dLat/2)**2 +
    Math.cos(rad(p1.lat)) *
    Math.cos(rad(p2.lat)) *
    Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function bearing(p1, p2) {
  const y = Math.sin(rad(p2.lon-p1.lon)) * Math.cos(rad(p2.lat));
  const x = Math.cos(rad(p1.lat))*Math.sin(rad(p2.lat)) -
    Math.sin(rad(p1.lat))*Math.cos(rad(p2.lat))*Math.cos(rad(p2.lon-p1.lon));
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

function rad(v){ return v * Math.PI / 180; }

function centroid(ps) {
  let lat=0, lon=0;
  ps.forEach(p => { lat+=p.lat; lon+=p.lon; });
  return [lat/3, lon/3];
}

function reset() {
  markers.forEach(m => map.removeLayer(m));
  if (line) map.removeLayer(line);
  points = [];
  markers = [];
  line = null;
}
</script>

</body>
</html>
